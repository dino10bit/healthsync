# PRD Section 34: Data Export Feature

## 1. Executive Summary

This document provides the detailed technical and functional specification for the **Data Export** feature in SyncWell. This feature empowers users with true ownership of their health data by allowing them to export it from any connected source into standard, open file formats (FIT, TCX, GPX, CSV). This is a key power-user feature that aligns with our principles of transparency and user control.

This specification details a robust architecture for fetching, formatting, and exporting data, including a streaming approach for handling large datasets and a validation suite to ensure format compliance. For the **solo developer**, this provides a clear plan for implementing a complex feature reliably and efficiently.

## 2. Data Export Architecture

The export feature will be built on a modular, streaming architecture to ensure performance and reliability.

*   **`ExportManager`:** This is the high-level service that the UI interacts with. It manages the export job, coordinates the other components, and provides progress updates to the UI.
*   **Streaming Fetch:** The `ExportManager` will not fetch the entire date range of data at once. It will request data from the `DataProvider` in smaller, sequential chunks (e.g., one month at a time) to keep memory usage low.
*   **`Exporter` (Interface):** A standardized interface for all file formatters.
    ```typescript
    interface Exporter {
      // Returns the file extension (e.g., "fit", "csv")
      getFileExtension(): string;

      // Initializes the export, e.g., writing file headers
      beginExport(tempFilePath: string): Promise<void>;

      // Appends a chunk of canonical data to the file
      appendData(data: CanonicalData[]): Promise<void>;

      // Finalizes the export, e.g., writing footers or calculating checksums
      endExport(): Promise<string>; // Returns the final file path
    }
    ```
*   **Concrete Implementations:** `FitFileExporter`, `TcxFileExporter`, `GpxExporter`, `CsvExporter`. Each will encapsulate the logic and any third-party libraries needed for its specific format.

## 3. User Experience & Workflow

1.  **Configuration:** The user navigates to "Export Data," selects the source app, data type(s), and a date range.
2.  **Initiation:** The user taps "Start Export."
3.  **Process:**
    *   The `ExportManager` starts the job on a **background thread**.
    *   The UI displays a progress bar and a message, e.g., "Exporting... Fetching data for January 2023."
    *   The `ExportManager` iterates through the date range in monthly chunks, fetching data and passing it to the appropriate `Exporter`'s `appendData` method.
    *   The UI progress bar updates as each chunk is processed.
4.  **Completion:**
    *   Once complete, the `ExportManager`'s `endExport` method finalizes the file.
    *   A local push notification is sent to the user: "Your data export is complete and ready to save."
    *   Tapping the notification (or the "Save File" button in the UI) opens the native OS Share Sheet, allowing the user to save the file to any destination.

## 4. File Format Specifications

| Data Type | Supported Formats | Technical Notes & Validation |
| :--- | :--- | :--- |
| **Activities** | **FIT, TCX, GPX, CSV**| **FIT** is the primary, richest format. The `FitFileExporter` will use the official Garmin FIT SDK definitions. **GPX** will only be generated for activities with GPS data. **CSV** will be a summary view. |
| **Daily Steps**| **CSV** | A CSV with columns: `date` (YYYY-MM-DD), `step_count`. |
| **Weight** | **CSV** | A CSV with columns: `timestamp` (ISO 8601), `weight_kg`, `body_fat_percentage`, `bmi`. |
| **Sleep** | **CSV** | A CSV with columns: `start_time`, `end_time`, `total_duration_seconds`, `duration_asleep_seconds`, `duration_in_rem_seconds`, etc. |

## 5. Export Validation Suite (QA)

To ensure the integrity of our exported files, a formal validation process will be implemented.

*   **Golden Files:** A "golden set" of sample `.fit`, `.tcx`, and `.gpx` files, generated by SyncWell, will be checked into the source code repository. These files are known to be valid.
*   **CI/CD Validation Job:** A new job will be added to the CI/CD pipeline that runs on every release branch.
    *   **Step 1:** The job will use an official command-line validation tool (e.g., Garmin's `FitCSVTool.jar` for FIT files) to validate the "golden files." This ensures we don't have regressions in our file generation logic.
    *   **Step 2:** The job will also perform round-trip testing. It will take a golden file, run it through SyncWell's *importer* to create a canonical object, and then run that object through the *exporter*. The resulting file is then compared against the original golden file.

## 6. Risk Analysis & Mitigation

(This section remains largely the same but is included for completeness.)

| Risk ID | Risk Description | Probability | Impact | Mitigation Strategy |
| :--- | :--- | :--- | :--- | :--- |
| **R-91** | The generated export files are corrupt or do not comply with the format standards. | **Low** | **High** | The formal "Export Validation Suite" in the CI/CD pipeline is the primary mitigation. This provides automated, continuous validation of our file generation logic. |
| **R-92** | Exporting a very large date range causes the app to run out of memory and crash. | **Low** | **Medium** | The streaming architecture (fetching and writing in monthly chunks) is designed specifically to mitigate this risk by keeping memory usage flat regardless of the export size. |
| **R-93** | The chosen third-party library for a specific file format is abandoned or has a critical bug. | **Low** | **Medium** | The `Exporter` interface acts as an adapter. This makes it much easier to swap out one underlying library for another without changing the rest of the export logic. |

## 7. Optional Visuals / Diagram Placeholders
*   **[Diagram] Export Architecture:** A component diagram showing the `ExportManager`, the `DataProvider`, and the different `Exporter` interface implementations.
*   **[Sequence Diagram] Streaming Export:** A sequence diagram illustrating the process of exporting a large date range, showing the loop of fetching a chunk, appending it to the file, and updating the UI.
*   **[Mockup] Export Progress:** A mockup of the UI showing the export in progress with a progress bar and a "Cancel" button.
*   **[Diagram] CI/CD Validation Flow:** A flowchart showing the "Export Validation Suite" job, including the validation and round-trip testing steps.
