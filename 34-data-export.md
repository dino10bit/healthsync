## Dependencies

### Core Dependencies
- `30-sync-mapping.md` - Source-Destination Sync Mapping
- `35-data-import.md` - Data Import Feature
- `14-qa-testing.md` - QA & Testing Strategy

### Strategic / Indirect Dependencies
- `19-security-privacy.md` - Data Security & Privacy Policies
- `36-user-privacy-settings.md` - User Privacy Controls & Settings

---

# PRD Section 34: Data Export Feature

## 1. Executive Summary

This document provides the detailed specification for the **Data Export** feature. This feature empowers users with true ownership of their data by allowing them to export it into standard, open file formats (FIT, TCX, GPX, CSV).

To ensure reliability and performance, especially for large exports, this feature is built on an **asynchronous, backend-driven architecture**. This specification details the process of offloading export jobs to the backend, processing them reliably, and notifying the user when the export is ready for download.

## 2. Data Export Architecture (Backend-Driven)

The export process is offloaded to the backend to avoid performance, battery, and reliability issues associated with on-device processing.

1.  **Initiation (Mobile):** The user selects the source, date range, and format in the mobile app and taps "Start Export."
2.  **Job Request (Mobile -> Backend):** The app sends a request to a new `/export` endpoint on our API Gateway.
3.  **Queueing (Backend):** The backend creates a new export job entry in a DynamoDB table and places a corresponding job message into a dedicated **`export-queue` in SQS**.
4.  **Processing (Backend):** A dedicated fleet of **`export-workers` (AWS Lambdas)** polls the `export-queue`. A worker processes the job by:
    *   Fetching all the required data from the third-party API.
    *   Using the `Exporter` modules to format the data into the requested file type(s).
    *   Compressing the files into a single `.zip` archive.
5.  **Storage & Notification (Backend):**
    *   The worker uploads the final `.zip` file to a secure, temporary folder in **S3**.
    *   The worker updates the job's status to `COMPLETED` in DynamoDB and adds the secure, time-limited S3 download URL.
    *   The backend sends a **push notification** to the user.
6.  **Download (Mobile):** The user taps the notification, and the mobile app downloads the file from the S3 URL.

## 3. User Experience & Workflow

The user experience is designed to be simple and asynchronous.

1.  **Configuration:** The user configures their export in the app.
2.  **Initiation:** After tapping "Start Export," the UI updates to show a persistent status indicator: *"Your export is being prepared. We will notify you when it's ready to download."*
3.  **Wait:** The user can now safely close the app. The export is processed on the backend.
4.  **Completion Notification:** Once the export is complete, the user receives a push notification: *"Your data export is ready to download."*
5.  **Download:** Tapping the notification opens the app to a screen where they can download the `.zip` file. The download link will be valid for a limited time (e.g., 24 hours).

## 4. File Format Specifications

| Data Type | Supported Formats | Notes |
| :--- | :--- | :--- |
| **Activities** | **FIT, TCX, GPX, CSV**| **FIT** is the primary, richest format. |
| **Daily Steps**| **CSV** | Columns: `date`, `step_count`. |
| **Weight** | **CSV** | Columns: `timestamp`, `weight_kg`, `body_fat_percentage`. |
| **Sleep** | **CSV** | Columns: `start_time`, `end_time`, `duration_asleep_seconds`, etc. |

## 5. Export Validation Suite (QA)

To ensure the integrity of our exported files, a validation process will be implemented in the **backend's CI/CD pipeline**.

*   **Golden Files:** A "golden set" of sample `.fit`, `.tcx`, etc., files will be stored in the repository.
*   **CI/CD Validation Job:** On every deployment, a job will run an official command-line tool (e.g., Garmin's `FitCSVTool.jar`) to validate that the files generated by the backend `Exporter` modules are compliant with their respective standards.

## 6. Risk Analysis & Mitigation

| Risk ID | Risk Description | Probability | Impact | Mitigation Strategy |
| :--- | :--- | :--- | :--- | :--- |
| **R-91** | The generated export files are corrupt or non-compliant. | **Low** | **High** | The formal "Export Validation Suite" in the backend CI/CD pipeline is the primary mitigation. |
| **R-92** | An export job for a very large date range exceeds the maximum Lambda execution time (15 mins). | **Medium** | **Medium** | The `export-worker` will be designed to be pausable and resumable. It will process data in chunks and, if nearing the timeout, will save its state and re-queue itself to continue where it left off. |
| **R-93** | The temporary S3 bucket for downloads is misconfigured, allowing public access. | **Low** | **Critical**| All S3 bucket policies will be defined in Terraform and will be set to private by default. Download links will be pre-signed, time-limited URLs, which provide secure, temporary access. |

## 7. Visual Diagrams

### Backend-Driven Export Architecture
```mermaid
graph TD
    subgraph Mobile App
        A[Initiate Export]
        H[Download File]
    end
    subgraph AWS Backend
        B[API Gateway]
        C[SQS Export Queue]
        D[Export Workers (Lambda)]
        E[DynamoDB Job Table]
        F[S3 for Exports]
        G[Push Notification Service]
    end

    A --> B;
    B -- Job Request --> C;
    B -- Creates Job --> E;
    D -- Polls --> C;
    D -- Fetches/Formats Data --> D;
    D -- Uploads File --> F;
    D -- Updates Status & URL --> E;
    D -- Triggers Push --> G;
    G --> H;
    H -- Uses URL from Backend --> F;
```
